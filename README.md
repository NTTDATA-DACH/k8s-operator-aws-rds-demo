# Kubernetes Operator AWS RDS Demo (k8s-operator-aws-rds-demo)

This project demonstrates the implementation of a Kubernetes operator that can create, update, and delete an AWS RDS instance based on a Custom Resource Definition (CRD).

The implementation fulfills the customer's defined requirements, which are outlined as follows:

> Task 3: As part of the platform we are providing a database as a service that teams can request. 
Please create a custom k8s operator for offering AWS RDS instance to a given stage, where credentials are stored as k8s secrets.

The project was scaffolded using [Operator SDK](https://operatorframework.io/) version v1.39.2 and [Go language](https://go.dev/) version 1.22.0.

## Operator's CRD

### Specification

The Custom Resource Definition (CRD) for the operator is generated by the project based on the following [specification](api/v1alpha1/awsrdsdemoinstance_types.go):

```
type AwsRDSDemoInstanceSpec struct {
	DBInstanceClass         string `json:"dbInstanceClass"`
	Engine                  string `json:"engine"`
	EngineVersion           string `json:"engineVersion"`
	DBName                  string `json:"dbName"`
	// +kubebuilder:validation:Minimum=20
	AllocatedStorage        int32  `json:"allocatedStorage"`
	Stage                   string `json:"stage"`
	CredentialSecretName    string `json:"credentialSecretName"`
}
```

### CRD Example

An example of a manually tested CRD against real AWS EKS cluster can be found [here](config/samples/aws_v1alpha1_awsrdsdemoinstance.yaml):

```
apiVersion: aws.nttdata.com/v1alpha1
kind: AwsRDSDemoInstance
metadata:
  labels:
    app.kubernetes.io/name: k8s-operator-aws-rds-demo
    app.kubernetes.io/managed-by: kustomize
  name: awsrdsdemoinstance-dev
spec:
  dbInstanceClass: "db.t3.micro" # micro, small, medium, large
  engine: "postgres"
  engineVersion: "17.2" # 17.4, 17.2
  dbName: "k8soperatorawsrdsdemo"
  allocatedStorage: 30
  stage: "dev"
  credentialSecretName: "postgresql-secret"
```

### CDR Updates

For the demonstration purposes the reconciliation loop of this operator reacts to the changes to the following CRD attributes only:
* DBInstanceClass
* EngineVersion
* AllocatedStorage

All other spec attributes are ignored if modified.

## AWS RDS Integration

**NOTE**: The configuration of the integration was executed manually, as the automation of this part was not a part of the task.

### Defining AWS IAM's Role for EKS-RDS Communication

To allow communication between the Operator code and RDS we must define a special IAM Role with defined Trust relationships and permission.

The Trust relationships of the Role must be defined as follows:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::<Account ID>:oidc-provider/oidc.eks.eu-central-1.amazonaws.com/id/<OpenID Connect provider>"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "oidc.eks.eu-central-1.amazonaws.com/id/<OpenID Connect provider>:sub": "system:serviceaccount:k8s-operator-aws-rds-demo-system:k8s-operator-aws-rds-demo-controller-manager",
                    "oidc.eks.eu-central-1.amazonaws.com/id/<OpenID Connect provider>:aud": "sts.amazonaws.com"
                }
            }
        }
    ]
}
```

And the Role needs following RDS permissions defined in the attached policy:
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "rds:CreateDBInstance",
                "rds:DescribeDBInstances",
                "rds:DeleteDBInstance",
                "rds:ModifyDBInstance"
            ],
            "Resource": "*"
        }
    ]
}
```

### Annotating Operator Pod's Service Account

To allow operate's pod connect to RDS managed service and create, update or delete a RDS instance the pod's [Service account](config/rbac/service_account.yaml) has to be specially annotated
with the previously defined IAM Role Arn:
```
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::<Account ID>:role/<AmazonEKSServiceAccountRDSRole>
```

This annotation causes that [IRSA](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html) makes the token available to the AWS SDK which is used by the Operator's reconciliation function to communicate with the RDS. 

## Building and Deploying

**NOTE**: This part of this document was generated by the Operator SDK.

### Prerequisites
- go version v1.22.0+
- docker version 17.03+.
- kubectl version v1.11.3+.
- Access to a Kubernetes v1.11.3+ cluster.

### To Deploy on the cluster
**Build and push your image to the location specified by `IMG`:**

```sh
make docker-build docker-push IMG=<some-registry>/k8s-operator-aws-rds-demo:tag
```

**NOTE:** This image ought to be published in the personal registry you specified.
And it is required to have access to pull the image from the working environment.
Make sure you have the proper permission to the registry if the above commands donâ€™t work.

**Install the CRDs into the cluster:**

```sh
make install
```

**Deploy the Manager to the cluster with the image specified by `IMG`:**

```sh
make deploy IMG=<some-registry>/k8s-operator-aws-rds-demo:tag
```

> **NOTE**: If you encounter RBAC errors, you may need to grant yourself cluster-admin
privileges or be logged in as admin.

**Create instances of your solution**
You can apply the samples (examples) from the config/sample:

```sh
kubectl apply -k config/samples/
```

>**NOTE**: Ensure that the samples has default values to test it out.

### To Uninstall
**Delete the instances (CRs) from the cluster:**

```sh
kubectl delete -k config/samples/
```

**Delete the APIs(CRDs) from the cluster:**

```sh
make uninstall
```

**UnDeploy the controller from the cluster:**

```sh
make undeploy
```

## Project Distribution

**NOTE**: This part of this document was generated by the Operator SDK.

Following are the steps to build the installer and distribute this project to users.

1. Build the installer for the image built and published in the registry:

```sh
make build-installer IMG=<some-registry>/k8s-operator-aws-rds-demo:tag
```

NOTE: The makefile target mentioned above generates an 'install.yaml'
file in the dist directory. This file contains all the resources built
with Kustomize, which are necessary to install this project without
its dependencies.

2. Using the installer

Users can just run kubectl apply -f <URL for YAML BUNDLE> to install the project, i.e.:

```sh
kubectl apply -f https://raw.githubusercontent.com/<org>/k8s-operator-aws-rds-demo/<tag or branch>/dist/install.yaml
```

More information can be found via the [Kubebuilder Documentation](https://book.kubebuilder.io/introduction.html)

## Logging

For the demo purposes the Operator logs core actions into pod's log. This allows better demonstration of the actions
done under the hood. Here an example of the log output:

```
2025-04-22T07:00:09Z	INFO	setup	starting manager
2025-04-22T07:00:09Z	INFO	controller-runtime.metrics	Starting metrics server
2025-04-22T07:00:09Z	INFO	setup	disabling http/2
2025-04-22T07:00:09Z	INFO	starting server	{"name": "health probe", "addr": "[::]:8081"}
I0422 07:00:09.269212       1 leaderelection.go:254] attempting to acquire leader lease k8s-operator-aws-rds-demo-system/b6331073.nttdata.com...
I0422 07:00:09.286156       1 leaderelection.go:268] successfully acquired lease k8s-operator-aws-rds-demo-system/b6331073.nttdata.com
2025-04-22T07:00:09Z	DEBUG	events	k8s-operator-aws-rds-demo-controller-manager-bbf6f5f7b-mwvzs_130bf20d-57a9-4437-8048-b9cba74a3dc7 became leader	{"type": "Normal", "object": {"kind":"Lease","namespace":"k8s-operator-aws-rds-demo-system","name":"b6331073.nttdata.com","uid":"19fed191-ddf7-49d2-bfea-31b61ce71d2e","apiVersion":"coordination.k8s.io/v1","resourceVersion":"2023322"}, "reason": "LeaderElection"}
2025-04-22T07:00:09Z	INFO	Starting EventSource	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "source": "kind source: *v1alpha1.AwsRDSDemoInstance"}
2025-04-22T07:00:09Z	INFO	Starting Controller	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance"}
2025-04-22T07:00:09Z	INFO	Starting workers	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "worker count": 1}
2025-04-22T07:00:09Z	INFO	reconcile triggered for 'awsrdsdemoinstance-dev' in namespace 'default'...	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "694f1d72-a866-4244-a12c-a03367406626"}
2025-04-22T07:00:09Z	INFO	found: awsrdsdemoinstance-dev	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "694f1d72-a866-4244-a12c-a03367406626"}
2025-04-22T07:00:09Z	INFO	adding finalizer for AwsRDSDemoInstance	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "694f1d72-a866-4244-a12c-a03367406626"}
2025-04-22T07:00:09Z	INFO	added finalizer for AwsRDSDemoInstance	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "694f1d72-a866-4244-a12c-a03367406626"}
2025-04-22T07:00:09Z	INFO	controller-runtime.metrics	Serving metrics server	{"bindAddress": ":8443", "secure": true}
2025-04-22T07:00:09Z	INFO	starting to create db instance: k8soperatorawsrdsdemo-dev	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "694f1d72-a866-4244-a12c-a03367406626"}
2025-04-22T07:00:13Z	INFO	db instance for engine 'postgres:17.2' with the name 'k8soperatorawsrdsdemo' with identifier 'k8soperatorawsrdsdemo-dev' created successfully	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "694f1d72-a866-4244-a12c-a03367406626"}
2025-04-22T07:00:13Z	INFO	reconcile finished...	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "694f1d72-a866-4244-a12c-a03367406626"}
2025-04-22T07:00:13Z	INFO	reconcile triggered for 'awsrdsdemoinstance-dev' in namespace 'default'...	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "614d2299-966e-438a-8a21-54be96b4e616"}
2025-04-22T07:00:13Z	INFO	found: awsrdsdemoinstance-dev	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "614d2299-966e-438a-8a21-54be96b4e616"}
2025-04-22T07:00:13Z	INFO	reconcile finished...	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "614d2299-966e-438a-8a21-54be96b4e616"}
2025-04-22T07:41:49Z	INFO	reconcile triggered for 'awsrdsdemoinstance-dev' in namespace 'default'...	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "f0d8b665-486d-48e1-bef7-0cccf8016a6d"}
2025-04-22T07:41:49Z	INFO	found: awsrdsdemoinstance-dev	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "f0d8b665-486d-48e1-bef7-0cccf8016a6d"}
2025-04-22T07:41:50Z	INFO	detected modification of AllocatedStorage, will try to update db instance	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "f0d8b665-486d-48e1-bef7-0cccf8016a6d"}
2025-04-22T07:41:50Z	INFO	starting to update db instance: k8soperatorawsrdsdemo-dev	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "f0d8b665-486d-48e1-bef7-0cccf8016a6d"}
2025-04-22T07:41:50Z	INFO	db instance updated successfully	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "f0d8b665-486d-48e1-bef7-0cccf8016a6d"}
2025-04-22T07:41:50Z	INFO	reconcile finished...	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "f0d8b665-486d-48e1-bef7-0cccf8016a6d"}
2025-04-22T07:53:13Z	INFO	reconcile triggered for 'awsrdsdemoinstance-dev' in namespace 'default'...	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "68af51df-c55d-475c-8eda-e9eeb8396f02"}
2025-04-22T07:53:13Z	INFO	found: awsrdsdemoinstance-dev	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "68af51df-c55d-475c-8eda-e9eeb8396f02"}
2025-04-22T07:53:14Z	INFO	detected modification of DBInstanceClass, will try to update db instance	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "68af51df-c55d-475c-8eda-e9eeb8396f02"}
2025-04-22T07:53:14Z	INFO	starting to update db instance: k8soperatorawsrdsdemo-dev	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "68af51df-c55d-475c-8eda-e9eeb8396f02"}
2025-04-22T07:53:15Z	INFO	db instance updated successfully	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "68af51df-c55d-475c-8eda-e9eeb8396f02"}
2025-04-22T07:53:15Z	INFO	reconcile finished...	{"controller": "awsrdsdemoinstance", "controllerGroup": "aws.nttdata.com", "controllerKind": "AwsRDSDemoInstance", "AwsRDSDemoInstance": {"name":"awsrdsdemoinstance-dev","namespace":"default"}, "namespace": "default", "name": "awsrdsdemoinstance-dev", "reconcileID": "68af51df-c55d-475c-8eda-e9eeb8396f02"}
```

## License

Copyright 2025 NTT DATA.


